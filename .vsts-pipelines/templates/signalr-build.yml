parameters:
  queueName: ''
  beforeBuild: []
  afterBuild: []
  variables:

phases:
- phase: Windows
  queue:
    name: ${{ parameters.queueName }}
  variables:
    BuildConfiguration: Release
    ${{ insert }}: ${{ parameters.variables }}
  steps:
  - checkout: self
    clean: true

  - ${{ parameters.beforeBuild }}

  - script: .\build.cmd -ci /p:Configuration=$(BuildConfiguration)
    displayName: Run build.cmd

  - task: PublishTestResults@2
    displayName: Publish test results
    condition: always()
    inputs:
      testRunner: vstest
      testResultsFiles: 'artifacts/logs/**/*.trx'

  - task: PublishBuildArtifacts@1
    displayName: Upload artifacts
    condition: and(always(), eq(variables['system.pullrequest.isfork'], false))
    inputs:
      pathtoPublish: artifacts/$(BuildConfiguration)/
      artifactName: artifacts-$(BuildConfiguration)
      artifactType: Container

  - task: PublishBuildArtifacts@1
    displayName: Upload logs
    condition: and(always(), eq(variables['system.pullrequest.isfork'], false))
    inputs:
      pathtoPublish: artifacts/logs/
      artifactName: logs-$(BuildConfiguration)
      artifactType: Container

  - task: PublishSymbols@2
    displayName: 'Publish symbols path'
    inputs:
      SearchPattern: 'artifacts\$(BuildConfiguration)\symbols\windows\**\*.pdb'
      SymbolServerType: FileShare
      SymbolsProduct: AspNetSignalR
      SymbolsPath: '$(DropShareRoot)\$(Build.BuildNumber)'
      SymbolsArtifactName: 'symbols-$(BuildConfiguration)'

      # We use SourceLink at build time, and Pdb2Pdb translates that to srcsrv at conversion time
      IndexSources: false

  - ${{ parameters.afterBuild }}